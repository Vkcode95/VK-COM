name: Build VK Shop APK (Firebase + Auth)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"

      - name: Create Flutter project, add firebase, build APK
        run: |
          set -e

          # create flutter project
          flutter create --org com.vk --project-name store vk_shop_app
          cd vk_shop_app

          # copy firebase config if present in repo
          if [ -f ../.github/firebase/google-services.json ]; then
            mkdir -p android/app
            cp ../.github/firebase/google-services.json android/app/google-services.json
          fi

          # Replace pubspec.yaml to include firebase packages
          cat > pubspec.yaml << 'PUB'
          name: vk_shop_app
          description: VK Store with Firebase Auth
          publish_to: 'none'
          version: 1.0.0+1

          environment:
            sdk: ">=3.0.0 <4.0.0"

          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.6
            firebase_core: ^2.24.2
            firebase_auth: ^4.17.4
            google_sign_in: ^6.2.1
            provider: ^6.1.2

          dev_dependencies:
            flutter_test:
              sdk: flutter

          flutter:
            uses-material-design: true
          PUB

          flutter pub get

          # Write a new main.dart with Firebase initialization and login UI
          mkdir -p lib
          cat > lib/main.dart << 'EOF'
          import 'package:flutter/material.dart';
          import 'package:firebase_core/firebase_core.dart';
          import 'package:firebase_auth/firebase_auth.dart';
          import 'package:google_sign_in/google_sign_in.dart';

          Future<void> main() async {
            WidgetsFlutterBinding.ensureInitialized();
            await Firebase.initializeApp();
            runApp(const VkShopApp());
          }

          class VkShopApp extends StatelessWidget {
            const VkShopApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MaterialApp(
                debugShowCheckedModeBanner: false,
                title: 'VK Store',
                theme: ThemeData(
                  useMaterial3: true,
                  colorSchemeSeed: Colors.indigo,
                ),
                home: const AuthGate(),
              );
            }
          }

          class AuthGate extends StatelessWidget {
            const AuthGate({super.key});

            @override
            Widget build(BuildContext context) {
              return StreamBuilder<User?>(
                stream: FirebaseAuth.instance.authStateChanges(),
                builder: (context, snapshot) {
                  if (snapshot.connectionState == ConnectionState.waiting) {
                    return const Scaffold(body: Center(child: CircularProgressIndicator()));
                  }
                  if (snapshot.hasData) {
                    return const HomeScreen();
                  } else {
                    return const LoginScreen();
                  }
                },
              );
            }
          }

          class LoginScreen extends StatefulWidget {
            const LoginScreen({super.key});
            @override
            State<LoginScreen> createState() => _LoginScreenState();
          }

          class _LoginScreenState extends State<LoginScreen> {
            final TextEditingController _email = TextEditingController();
            final TextEditingController _password = TextEditingController();
            bool _loading = false;
            String? _error;

            Future<void> _signInEmail() async {
              setState(() { _loading = true; _error = null; });
              try {
                await FirebaseAuth.instance.signInWithEmailAndPassword(
                  email: _email.text.trim(),
                  password: _password.text.trim(),
                );
              } on FirebaseAuthException catch (e) {
                if (e.code == 'user-not-found') {
                  try {
                    await FirebaseAuth.instance.createUserWithEmailAndPassword(
                      email: _email.text.trim(),
                      password: _password.text.trim(),
                    );
                  } on FirebaseAuthException catch (e2) {
                    _error = e2.message;
                  }
                } else {
                  _error = e.message;
                }
              } finally {
                if (mounted) setState(() { _loading = false; });
              }
            }

            Future<void> _signInGoogle() async {
              setState(() { _loading = true; _error = null; });
              try {
                final GoogleSignInAccount? googleUser = await GoogleSignIn().signIn();
                if (googleUser == null) return;
                final GoogleSignInAuthentication googleAuth = await googleUser.authentication;
                final credential = GoogleAuthProvider.credential(
                  accessToken: googleAuth.accessToken,
                  idToken: googleAuth.idToken,
                );
                await FirebaseAuth.instance.signInWithCredential(credential);
              } catch (e) {
                _error = e.toString();
              } finally {
                if (mounted) setState(() { _loading = false; });
              }
            }

            @override
            Widget build(BuildContext context) {
              return Scaffold(
                appBar: AppBar(title: const Text('VK Store â€” Login')),
                body: Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      TextField(controller: _email, decoration: const InputDecoration(labelText: 'Email')),
                      const SizedBox(height: 12),
                      TextField(controller: _password, obscureText: true, decoration: const InputDecoration(labelText: 'Password')),
                      const SizedBox(height: 16),
                      if (_error != null) Text(_error!, style: const TextStyle(color: Colors.red)),
                      const SizedBox(height: 8),
                      ElevatedButton(
                        onPressed: _loading ? null : _signInEmail,
                        child: _loading ? const CircularProgressIndicator() : const Text('Sign in (or create)'),
                      ),
                      const SizedBox(height: 12),
                      ElevatedButton(
                        onPressed: _loading ? null : _signInGoogle,
                        child: const Text('Sign in with Google'),
                      ),
                    ],
                  ),
                ),
              );
            }
          }

          class HomeScreen extends StatelessWidget {
            const HomeScreen({super.key});
            @override
            Widget build(BuildContext context) {
              final user = FirebaseAuth.instance.currentUser;
              return Scaffold(
                appBar: AppBar(
                  title: const Text('VK Store'),
                  actions: [
                    IconButton(
                      icon: const Icon(Icons.logout),
                      onPressed: () async { await FirebaseAuth.instance.signOut(); },
                    )
                  ],
                ),
                body: Center(
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text('Logged in as ${user?.email ?? user?.uid ?? "User"}'),
                      const SizedBox(height: 12),
                      const Text('This is a basic home screen. Next we will add products, cart and orders.'),
                    ],
                  ),
                ),
              );
            }
          }
          EOF

          # get packages and build release APK
          flutter pub get
          flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: vk-shop-apk
          path: vk_shop_app/build/app/outputs/flutter-apk/app-release.apk
